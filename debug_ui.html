<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Jobs Selection Debug</title>
    <style>
      :root {
        --bg: #0f1220;
        --card: #171a2b;
        --muted: #9aa4bf;
        --text: #eef1ff;
        --accent: #f4b266;
        --accent-2: #6fc3df;
        --border: #2a2f45;
        --chip: #1f2438;
        --shadow: 0 12px 30px rgba(0,0,0,0.35);
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "Space Grotesk", "Satoshi", "Segoe UI", sans-serif;
        background: radial-gradient(1200px 600px at 10% -20%, #243b55 0%, transparent 60%),
                    radial-gradient(800px 500px at 90% -10%, #3b2f2f 0%, transparent 60%),
                    var(--bg);
        color: var(--text);
      }
      header {
        padding: 28px 28px 12px;
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        gap: 16px;
      }
      h1 {
        margin: 0;
        font-size: 28px;
        letter-spacing: 0.2px;
      }
      .sub {
        color: var(--muted);
        font-size: 14px;
        margin-top: 6px;
      }
      .stats {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .chip {
        background: var(--chip);
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 12px;
        color: var(--muted);
      }
      .container {
        padding: 0 24px 32px;
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
      }
      .panel {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: var(--shadow);
        padding: 16px;
      }
      .filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));\n      gap: 12px;
      }
      input, select, button, textarea {
        font: inherit;
        color: var(--text);
      }
      input, select {
        background: #111427;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px 12px;
        width: 100%;\n      outline: none;
      }
      button {
        background: linear-gradient(135deg, var(--accent), #f7d199);
        border: none;
        color: #1b1b1b;
        padding: 10px 14px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
      }
      button.secondary {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text);
      }
      .table-wrap {
        overflow: auto;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #101424;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 720px;
      }
      thead th {
        position: sticky;
        top: 0;
        background: #12162b;
        text-align: left;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        padding: 12px;
        border-bottom: 1px solid var(--border);
      }
      tbody td {
        padding: 12px;
        border-bottom: 1px solid var(--border);
        font-size: 14px;
      }
      tbody tr:hover {
        background: rgba(255,255,255,0.03);
      }
      .row-title {
        font-weight: 600;
        margin-bottom: 4px;
      }
      .row-meta {
        color: var(--muted);
        font-size: 12px;
      }
      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 999px;
        background: rgba(111,195,223,0.15);
        color: var(--accent-2);\n      font-size: 11px;\n      border: 1px solid rgba(111,195,223,0.3);
      }
      .footer-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }
      .selected-list {
        max-height: 120px;
        overflow: auto;
        border: 1px dashed var(--border);
        padding: 8px;
        border-radius: 10px;
        background: #0f1220;
        font-size: 12px;
        color: var(--muted);
      }
      .action-row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      .pagination {
        display: flex;
        gap: 8px;
        align-items: center;
        color: var(--muted);
        font-size: 13px;
      }
      .empty {
        text-align: center;
        padding: 40px;
        color: var(--muted);
      }
      @media (max-width: 780px) {
        header {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div>
        <h1>Job Selection Console</h1>
        \n
        <div class="sub">
          Pick jobs to advance in the workflow. Latest records are loaded from
          Supabase.
        </div>
      </div>
      <div class="stats">
        <div class="chip" id="total-count">0 jobs</div>
        \n
        <div class="chip" id="filtered-count">0 shown</div>
        <div class="chip" id="selected-count">0 selected</div>
      </div>
    </header>
    \n\n
    <div class="container">
      \n
      <div class="panel">
        \n
        <div class="filters">
          <input
            id="search"
            type="text"
            placeholder="Search title, company, location..."
          />
          <select id="filter-remote">
            <option value="">Remote + On-site</option>
            <option value="remote">Remote only</option>
            <option value="onsite">On-site only</option>
          </select>
          <select id="filter-type">
            <option value="">All employment types</option>
          </select>
          <select id="sort">
            <option value="recent">Sort by recent</option>
            <option value="company">Sort by company</option>
            <option value="title">Sort by title</option>
          </select>
        </div>
      </div>
      \n\n
      <div class="panel">
        \n
        <div class="table-wrap">
          \n
          <table>
            \n
            <thead>
              \n
              <tr>
                <th style="width: 48px">
                  <input id="toggle-all" type="checkbox" />
                </th>
                \n
                <th>Role</th>
                \n
                <th>Company</th>
                \n
                <th>Location</th>
                \n
                <th>Type</th>
                \n
                <th>Remote</th>
                \n
                <th>Posted</th>
                \n
                <th>Link</th>
                \n
              </tr>
              \n
            </thead>
            \n
            <tbody id="table-body"></tbody>
            \n
          </table>
          <div id="empty" class="empty" style="display: none">
            No jobs match the current filters.
          </div>
        </div>
      </div>
      \n\n
      <div class="panel">
        \n
        <div class="footer-bar">
          \n
          <div class="pagination">
            \n <button class="secondary" id="prev-page">Prev</button>
            <span id="page-status">Page 1</span>
            <button class="secondary" id="next-page">Next</button>
          </div>
          <div class="action-row">
            <button class="secondary" id="clear-selection">
              Clear selection
            </button>
            <button id="submit-selection">Push selected to flow</button>
          </div>
        </div>
        <div style="margin-top: 12px">
          <div class="sub" style="margin-bottom: 6px">Selected jobs</div>
          <div id="selected-list" class="selected-list"></div>
        </div>
      </div>
    </div>
    \n\n
    <script>
      // SIMULATED DATA GENERATION (MATCHING THE NODE LOGIC)
      const jobs = [
        {
          id: "1",
          title: "Software Engineer",
          company: "Tech Corp",
          location: "Remote",
          country: "US",
          employmentType: "Full-time",
          remote: true,
          postedAt: "2023-10-27T00:00:00Z",
          url: "https://example.com/job1",
          createdAt: "2023-10-27T10:00:00Z",
        },
        {
          id: "2",
          title: "Product Manager",
          company: "Biz Inc",
          location: "New York, NY",
          country: "US",
          employmentType: "Contract",
          remote: false,
          postedAt: "2023-10-26T00:00:00Z",
          url: "https://example.com/job2",
          createdAt: "2023-10-26T10:00:00Z",
        },
        {
          id: "3",
          title: "Bad Strings ${Hello}",
          company: "Buggy `Co`",
          location: "Location \\ With Backslash",
          country: "US",
          employmentType: "Full-time",
          remote: true,
          postedAt: "2023-10-25T00:00:00Z",
          url: "",
          createdAt: "2023-10-25T10:00:00Z",
        },
      ];

      // THIS IS THE EXACT LOGIC FROM THE N8N NODE
      const safeJobsJson = JSON.stringify(jobs)
        .replace(/\\/g, "\\\\")
        .replace(/`/g, "\\`")
        .replace(/\${/g, "\\${")
        .replace(/</g, "\\u003c");

      // INJECTED INTO SCRIPT
      // Note: In the real browser, this is inside a template literal, so we simulate that here by outputting it
      console.log("Safe JSON:", safeJobsJson);

      // This is how it appears in the generated HTML source
      const JOBS = JSON.parse(safeJobsJson); // Wait, original code was `const JOBS = ${safeJobsJson};` DIRECT INJECTION
    </script>

    <script>
      // We need to simulate the injection exactly.
      // Since we can't dynamically generate this file easily with correct injection in one go,
      // I will use a second script tag that parses the string I prepared above,
      // OR we can just write the logic.

      // Let's emulate the failure mode.
      // If safeJobsJson was injected:
      // const JOBS = [{"id":"1", ... }];

      // I will manually reconstruct what the HTML source looks like:

      const JOBS = [
        {"id":"1","title":"Software Engineer","company":"Tech Corp","location":"Remote","country":"US","employmentType":"Full-time","remote":true,"postedAt":"2023-10-27T00:00:00Z","url":"https://example.com/job1","createdAt":"2023-10-27T10:00:00Z"},
        {"id":"2","title":"Product Manager","company":"Biz Inc","location":"New York, NY","country":"US","employmentType":"Contract","remote":false,"postedAt":"2023-10-26T00:00:00Z","url":"https://example.com/job2","createdAt":"2023-10-26T10:00:00Z"},
        {"id":"3","title":"Bad Strings \\${Hello}","company":"Buggy \\`Co\\`","location":"Location \\\\ With Backslash","country":"US","employmentType":"Full-time","remote":true,"postedAt":"2023-10-25T00:00:00Z","url":"","createdAt":"2023-10-25T10:00:00Z"}
      ];
      // NOTE: In the above line, I manually escaped backslashes to match what I THINK the output is.
      // If output was `\\\\` in the replacement, then `JSON.stringify` gave `\\`, replace made it `\\\\`.
      // So source code has `\\\\`.

      // Let's put the Variable logic here
      const state = {
        page: 1,
        perPage: 12,
        search: '',
        remote: '',
        type: '',
        sort: 'recent',
        selected: new Set(),
      };

      const el = (id) => document.getElementById(id);
      const tableBody = el('table-body');
      const empty = el('empty');
      const totalCount = el('total-count');
      const filteredCount = el('filtered-count');\n    const selectedCount = el('selected-count');
      const selectedList = el('selected-list');

      const typeFilter = el('filter-type');
      const uniqueTypes = Array.from(new Set(JOBS.map(j => j.employmentType).filter(Boolean))).sort();
      uniqueTypes.forEach((t) => {
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = t;
        typeFilter.appendChild(opt);\n    });

      const formatDate = (value) => {
        if (!value) return 'N/A';
        const d = new Date(value);
        if (Number.isNaN(d.getTime())) return value;
        return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
      };

      const normalize = (value) => String(value || '').toLowerCase();

      const getFiltered = () => {
        let items = JOBS.slice();
        if (state.search) {
          const s = normalize(state.search);
          items = items.filter(j => [j.title, j.company, j.location].some(v => normalize(v).includes(s)));
        }
        if (state.remote === 'remote') {
          items = items.filter(j => j.remote);
        }
        if (state.remote === 'onsite') {
          items = items.filter(j => !j.remote);
        }
        if (state.type) {
          items = items.filter(j => j.employmentType === state.type);
        }
        if (state.sort === 'company') {
          items.sort((a, b) => a.company.localeCompare(b.company));
        } else if (state.sort === 'title') {
          items.sort((a, b) => a.title.localeCompare(b.title));
        } else {
          items.sort((a, b) => new Date(b.postedAt || b.createdAt) - new Date(a.postedAt || a.createdAt));
        }
        return items;
      };

      const render = () => {
        const filtered = getFiltered();
        const total = JOBS.length;
        const totalPages = Math.max(1, Math.ceil(filtered.length / state.perPage));
        state.page = Math.min(state.page, totalPages);

        totalCount.textContent = `${total} jobs`;
        filteredCount.textContent = `${filtered.length} shown`;
        selectedCount.textContent = `${state.selected.size} selected`;

        const start = (state.page - 1) * state.perPage;
        const pageItems = filtered.slice(start, start + state.perPage);

        tableBody.innerHTML = '';
        if (!pageItems.length) {
          empty.style.display = 'block';
        } else {
          empty.style.display = 'none';
        }

        pageItems.forEach((job) => {
          const tr = document.createElement('tr');
          const checked = state.selected.has(job.id);
          tr.innerHTML = `
            <td><input type="checkbox" data-id="${job.id}" ${checked ? 'checked' : ''} /></td>
            <td><div class="row-title">${job.title}</div><div class="row-meta">${job.id}</div></td>
            <td>${job.company}</td>
            <td>${job.location}</td>
            <td>${job.employmentType || 'N/A'}</td>
            <td>${job.remote ? '<span class="badge">Remote</span>' : 'On-site'}</td>
            <td>${formatDate(job.postedAt || job.createdAt)}</td>
            <td>${job.url ? `<a href="${job.url}" target="_blank" rel="noopener" style="color: var(--accent-2);">Open</a>` : 'N/A'}</td>
          `;
          tableBody.appendChild(tr);
        });

        el('page-status').textContent = `Page ${state.page} of ${totalPages}`;
        renderSelectedList(filtered);
      };

      const renderSelectedList = (filtered) => {
        const selectedJobs = filtered.filter(j => state.selected.has(j.id));
        if (!selectedJobs.length) {
          selectedList.textContent = 'No jobs selected yet.';
          return;
        }
        selectedList.innerHTML = selectedJobs.map(j => `${j.title} â€” ${j.company}`).join('<br />');
      };

      const debounce = (fn, delay) => {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), delay);
        };
      };

      tableBody.addEventListener('change', (event) => {
        const target = event.target;
        if (target && target.matches('input[type="checkbox"][data-id]')) {
          const id = target.getAttribute('data-id');\n        if (target.checked) state.selected.add(id);
          else state.selected.delete(id);
          selectedCount.textContent = `${state.selected.size} selected`;
          renderSelectedList(getFiltered());
        }
      });

      el('toggle-all').addEventListener('change', (event) => {
        const checked = event.target.checked;
        getFiltered().slice((state.page - 1) * state.perPage, state.page * state.perPage).forEach((job) => {
          if (checked) state.selected.add(job.id);
          else state.selected.delete(job.id);
        });
        render();
      });

      el('search').addEventListener('input', debounce((e) => {
        state.search = e.target.value.trim();
        state.page = 1;
        render();
      }, 250));

      el('filter-remote').addEventListener('change', (e) => {
        state.remote = e.target.value;
        state.page = 1;
        render();
      });

      el('filter-type').addEventListener('change', (e) => {
        state.type = e.target.value;
        state.page = 1;
        render();
      });

      el('sort').addEventListener('change', (e) => {
        state.sort = e.target.value;
        render();
      });

      el('prev-page').addEventListener('click', () => {
        state.page = Math.max(1, state.page - 1);
        render();
      });

      el('next-page').addEventListener('click', () => {
        const maxPage = Math.ceil(getFiltered().length / state.perPage);
        state.page = Math.min(maxPage, state.page + 1);
        render();
      });

      el('clear-selection').addEventListener('click', () => {
        state.selected.clear();
        render();
      });

      render();
    </script>
  </body>
</html>
